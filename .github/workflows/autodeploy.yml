# å½“æœ‰æ”¹åŠ¨æ¨é€åˆ°masteråˆ†æ”¯æ—¶ï¼Œå¯åŠ¨Action
name: è‡ªåŠ¨éƒ¨ç½²

on:
  push:
    branches:
      - main #2020å¹´10æœˆågithubæ–°å»ºä»“åº“é»˜è®¤åˆ†æ”¯æ”¹ä¸ºmainï¼Œæ³¨æ„æ›´æ”¹

  release:
    types:
      - published

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€æŸ¥åˆ†æ”¯
        uses: actions/checkout@v2
        with:
          ref: main #2020å¹´10æœˆågithubæ–°å»ºä»“åº“é»˜è®¤åˆ†æ”¯æ”¹ä¸ºmainï¼Œæ³¨æ„æ›´æ”¹

      - name: å®‰è£… Node
        uses: actions/setup-node@v1
        with:
          node-version: "18.x" #actionä½¿ç”¨çš„nodeç‰ˆæœ¬ï¼Œå»ºè®®å¤§ç‰ˆæœ¬å’Œæœ¬åœ°ä¿æŒä¸€è‡´ã€‚å¯ä»¥åœ¨æœ¬åœ°ç”¨node -væŸ¥è¯¢ç‰ˆæœ¬å·ã€‚

      - name: å®‰è£… Hexo
        run: |
          export TZ='Asia/Shanghai'
          npm install hexo-cli -g

      - name: ç¼“å­˜ Hexo
        uses: actions/cache@v1
        id: cache
        with:
          path: node_modules
          key: ${{runner.OS}}-${{hashFiles('**/package-lock.json')}}

      - name: å®‰è£…ä¾èµ–
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          npm install --save

      - name: Restore file modification time ğŸ•’
        run: find source/_posts -name '*.md' | while read file; do touch -d "$(git log -1 --format="@%ct" "$file")" "$file"; done

      - name: ç”Ÿæˆé™æ€æ–‡ä»¶
        run: |
          hexo clean
          hexo generate

      - name: Setup Deploy Private Key
        env:
          HEXO_DEPLOY_PRIVATE_KEY: ${{ secrets.HEXO_DEPLOY_PRI }} # è¿™ä¸ªå°±æ˜¯Sourceä»“åº“çš„ç§é’¥
        run: |
          mkdir -p ~/.ssh/
          echo "$HEXO_DEPLOY_PRIVATE_KEY" > ~/.ssh/id_rsa 
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: Setup Git Infomation #æ­¤å¤„master:master æŒ‡ä»æœ¬åœ°çš„masteråˆ†æ”¯æäº¤åˆ°è¿œç¨‹ä»“åº“çš„masteråˆ†æ”¯ï¼Œè‹¥è¿œç¨‹ä»“åº“æ²¡æœ‰å¯¹åº”åˆ†æ”¯åˆ™æ–°å»ºä¸€ä¸ªã€‚å¦‚æœ‰å…¶ä»–éœ€è¦ï¼Œå¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚æ›´æ”¹ã€‚
        run: |
          git init
          git config --global user.name '${{ secrets.GITHUBUSERNAME }}'
          git config --global user.email '${{ secrets.GITHUBEMAIL }}'

      - name: steam é¡µé¢è·å–
        run: |
          hexo steam -u

      - name: è¿½ç•ªé¡µé¢è·å–
        run: |
          hexo bangumi -u

      - name: è¿½å‰§é¡µé¢è·å–
        run: |
          hexo cinema -u

      - name: è±†ç“£é¡µé¢è·å–
        run: |
          hexo douban -m

      - name: gulp å‹ç¼©
        run: |
          gulp

      - name: algolia ç¼“å­˜å»ºç«‹
        run: |
          hexo algolia

      - name: éƒ¨ç½² #æ­¤å¤„master:master æŒ‡ä»æœ¬åœ°çš„masteråˆ†æ”¯æäº¤åˆ°è¿œç¨‹ä»“åº“çš„masteråˆ†æ”¯ï¼Œè‹¥è¿œç¨‹ä»“åº“æ²¡æœ‰å¯¹åº”åˆ†æ”¯åˆ™æ–°å»ºä¸€ä¸ªã€‚å¦‚æœ‰å…¶ä»–éœ€è¦ï¼Œå¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚æ›´æ”¹ã€‚
        run: |
          hexo deploy
